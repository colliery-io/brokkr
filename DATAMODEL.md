# DataModel

```mermaid
classDiagram
    class base_table {
        +UUID id
        +TIMESTAMP created_at
        +TIMESTAMP updated_at
        +TIMESTAMP deleted_at
    }
    class agents {
        +UUID uuid [PK]
        +VARCHAR name
        +VARCHAR cluster_name
        +JSONB labels
        +JSONB annotations
        +TIMESTAMP last_heartbeat
        +VARCHAR status
    }
    class deployment_objects {
        +UUID uuid [PK]
        +BIGSERIAL sequence_id [UQ]
        +UUID stack_id [FK]
        +TEXT yaml_content
        +TEXT yaml_checksum
        +VARCHAR agent_target
        +JSONB agent_labels
        +JSONB agent_annotations
        +TIMESTAMP deleted_at
        +TIMESTAMP submitted_at
        +BOOLEAN is_deletion_marker
    }
    class stacks {
        +UUID id [PK]
        +VARCHAR name
        +TEXT description
        +INTERVAL retention_period
    }
    class agent_events {
        +UUID uuid [PK]
        +UUID agent_id [FK]
        +UUID deployment_object_id [FK]
        +VARCHAR event_type
        +ENUM status
        +TEXT message
    }
    base_table <|-- agents
    base_table <|-- stacks
    base_table <|-- agent_events
    stacks "1" -- "*" deployment_objects : has
    agents "1" -- "*" agent_events : generates
    deployment_objects "1" -- "*" agent_events : relates to
```

## Design Description:

1. Base Structure:
   - All tables inherit from `base_table`, which provides common fields like `id`, `created_at`, `updated_at`, and `deleted_at`.
   - The `update_timestamp()` function updates the `updated_at` field on any change.
   - The `soft_delete()` function sets the `deleted_at` field when a soft delete is performed.

2. Agents:
   - Represents the agents in the system.
   - Has a unique constraint on `(name, cluster_name)`.
   - Includes fields for labels, annotations, last heartbeat, and status that the Agent responds to.

3. Stacks:
   - Represents stacks in the system.
   - Has a unique constraint on `name`.

4. Deployment Objects:
   - Represents objects to be deployed.
   - Linked to a stack via `stack_id`.
   - Contains YAML content and its checksum.
   - Includes fields for targeting specific agents.
   - Has a `is_deletion_marker` flag for marking deletions.

5. Agent Events:
   - Represents events generated by agents on attempted apply.
   - Linked to both an agent and a deployment object.
   - Includes an event type, status (success/fail), and a message.

Cascading Events and Triggers:

1. Soft Delete Propagation:
   - When a stack is soft-deleted:
     a. The `handle_stack_soft_delete()` function is triggered.
     b. All existing deployment objects for the stack are soft-deleted.
     c. A new deployment object with blank content is created as a deletion marker.
   - When an agent is soft-deleted:
     a. The `cascade_soft_delete_agents()` function is triggered.
     b. All associated agent events are soft-deleted.

2. Hard Delete Propagation:
   - When a stack is hard-deleted:
     a. The `hard_delete_deployment_objects_on_stack_delete()` function is triggered.
     b. All associated agent events are hard-deleted.
     c. All deployment objects for the stack are hard-deleted.

3. Deployment Object Immutability:
   - The `prevent_deployment_object_changes()` function ensures that deployment objects cannot be modified after creation, except for soft deletion or updating deletion markers.

4. Timestamp Updates:
   - Any update to agents, stacks, or agent events triggers the `update_timestamp()` function, updating the `updated_at` field.

5. Soft Delete Mechanism:
   - Attempts to set `deleted_at` on agents, stacks, or agent events trigger the `soft_delete()` function, which sets the `deleted_at` timestamp.

