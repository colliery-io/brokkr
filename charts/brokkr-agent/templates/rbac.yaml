{{- if .Values.rbac.create -}}
apiVersion: rbac.authorization.k8s.io/v1
{{- if .Values.rbac.clusterWide }}
kind: ClusterRole
{{- else }}
kind: Role
{{- end }}
metadata:
  name: {{ include "brokkr-agent.fullname" . }}
  {{- if not .Values.rbac.clusterWide }}
  namespace: {{ .Release.Namespace }}
  {{- end }}
  labels:
    {{- include "brokkr-agent.labels" . | nindent 4 }}
rules:
# Core API - cluster inventory and monitoring
- apiGroups: [""]
  resources:
  - pods
  - pods/log
  - pods/status
  {{- if .Values.rbac.clusterWide }}
  - namespaces
  - nodes
  {{- end }}
  - services
  - endpoints
  - configmaps
  {{- if .Values.rbac.clusterWide }}
  - persistentvolumes
  {{- end }}
  - persistentvolumeclaims
  verbs:
  - get
  - list
  - watch
{{- if .Values.rbac.secretAccess.enabled }}
# Secrets - restricted access based on configuration
# WARNING: Secret access should be limited to specific namespaces in production
- apiGroups: [""]
  resources:
  - secrets
  verbs:
  {{- if .Values.rbac.secretAccess.readContents }}
  - get
  {{- end }}
  - list
  - watch
{{- end }}

# Apps API - workload inventory
- apiGroups: ["apps"]
  resources:
  - deployments
  - deployments/status
  - statefulsets
  - statefulsets/status
  - daemonsets
  - daemonsets/status
  - replicasets
  - replicasets/status
  verbs:
  - get
  - list
  - watch

# Batch API - job inventory
- apiGroups: ["batch"]
  resources:
  - jobs
  - jobs/status
  - cronjobs
  - cronjobs/status
  verbs:
  - get
  - list
  - watch

# Networking API - network policy inventory
- apiGroups: ["networking.k8s.io"]
  resources:
  - ingresses
  - ingresses/status
  - networkpolicies
  verbs:
  - get
  - list
  - watch

# RBAC API - security posture assessment
- apiGroups: ["rbac.authorization.k8s.io"]
  resources:
  - roles
  - rolebindings
  {{- if .Values.rbac.clusterWide }}
  - clusterroles
  - clusterrolebindings
  {{- end }}
  verbs:
  - get
  - list
  - watch

# Events - change tracking and debugging
- apiGroups: [""]
  resources:
  - events
  verbs:
  - get
  - list
  - watch

# Stack Deployment - full permissions for applying arbitrary manifests
# Agents are operators that need to deploy any K8s resources
- apiGroups: [""]
  resources: ["*"]
  verbs: ["*"]

- apiGroups: ["apps"]
  resources: ["*"]
  verbs: ["*"]

- apiGroups: ["batch"]
  resources: ["*"]
  verbs: ["*"]

- apiGroups: ["networking.k8s.io"]
  resources: ["*"]
  verbs: ["*"]

{{- if .Values.rbac.clusterWide }}
- apiGroups: ["rbac.authorization.k8s.io"]
  resources: ["*"]
  verbs: ["*"]
{{- end }}

{{- if .Values.shipwright.enabled }}
- apiGroups: ["shipwright.io"]
  resources: ["*"]
  verbs: ["*"]

- apiGroups: ["tekton.dev"]
  resources: ["*"]
  verbs: ["*"]
{{- end }}

{{- with .Values.rbac.additionalRules }}
{{ toYaml . }}
{{- end }}
---
apiVersion: rbac.authorization.k8s.io/v1
{{- if .Values.rbac.clusterWide }}
kind: ClusterRoleBinding
{{- else }}
kind: RoleBinding
{{- end }}
metadata:
  name: {{ include "brokkr-agent.fullname" . }}
  {{- if not .Values.rbac.clusterWide }}
  namespace: {{ .Release.Namespace }}
  {{- end }}
  labels:
    {{- include "brokkr-agent.labels" . | nindent 4 }}
roleRef:
  apiGroup: rbac.authorization.k8s.io
  {{- if .Values.rbac.clusterWide }}
  kind: ClusterRole
  {{- else }}
  kind: Role
  {{- end }}
  name: {{ include "brokkr-agent.fullname" . }}
subjects:
- kind: ServiceAccount
  name: {{ include "brokkr-agent.serviceAccountName" . }}
  namespace: {{ .Release.Namespace }}
{{- end }}
