---
name: brokkr-dev

services:
  postgres:
    image: postgres:15-alpine
    environment:
      - POSTGRES_USER=brokkr
      - POSTGRES_PASSWORD=brokkr
      - POSTGRES_DB=brokkr
    ports:
      - 5432:5432
    volumes:
      - brokkr-postgres-data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD", "pg_isready", "-U", "brokkr"]
      interval: 1s
      retries: 60
    restart: always

  brokkr-broker:
    command: serve
    build:
      context: ../..
      dockerfile: docker/Dockerfile.broker
    ports:
      - 3000:3000
    depends_on:
      postgres:
        condition: service_healthy
    environment:
      - BROKKR__DATABASE__URL=postgres://brokkr:brokkr@postgres:5432/brokkr
    volumes:
      - brokkr-keys:/tmp/brokkr-keys
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:3000/readyz"]
      interval: 5s
      timeout: 3s
      retries: 10

  init-agent:
    build:
      context: ../..
      dockerfile: docker/Dockerfile.broker
    depends_on:
      brokkr-broker:
        condition: service_healthy
    environment:
      - BROKKR__DATABASE__URL=postgres://brokkr:brokkr@postgres:5432/brokkr
    volumes:
      - brokkr-keys:/tmp/brokkr-keys
    user: "0:0"
    entrypoint: []
    command: >
      sh -c "
        ./brokkr-broker create agent --name brokkr-integration-test-agent --cluster-name brokkr-dev-integration-cluster | tee /tmp/brokkr-keys/agent.out &&
        grep 'Initial PAK:' /tmp/brokkr-keys/agent.out | cut -d' ' -f3 > /tmp/brokkr-keys/agent.pak
      "

  k3s:
    image: rancher/k3s:v1.30.10-k3s1
    command:
      - server
      - --cluster-init
      - --write-kubeconfig=/output/kubeconfig.yaml
      - --write-kubeconfig-mode=666
      - --tls-san=brokkr-dev-k3s-1
    privileged: true
    environment:
      - K3S_TOKEN=brokkr-secret
      - K3S_KUBECONFIG_OUTPUT=/output/kubeconfig.yaml
    volumes:
      - k3s-data:/var/lib/rancher/k3s
      - brokkr-keys:/output
      - ./k3s-registries.yaml:/etc/rancher/k3s/registries.yaml:ro
    depends_on:
      registry:
        condition: service_healthy
    ports:
      - "6443:6443"
    healthcheck:
      test: ["CMD", "kubectl", "get", "--raw", "/healthz"]
      interval: 10s
      timeout: 5s
      retries: 5

  init-kubeconfig:
    image: alpine
    depends_on:
      k3s:
        condition: service_healthy
    volumes:
      - brokkr-keys:/tmp/brokkr-keys
    command: >
      sh -c '
        apk add --no-cache sed &&
        # Create local kubeconfig
        cp /tmp/brokkr-keys/kubeconfig.yaml /tmp/brokkr-keys/kubeconfig.local.yaml &&
        sed -i "s|server: https://127.0.0.1:6443|server: https://localhost:6443|g" /tmp/brokkr-keys/kubeconfig.local.yaml &&

        # Create docker kubeconfig
        cp /tmp/brokkr-keys/kubeconfig.yaml /tmp/brokkr-keys/kubeconfig.docker.yaml &&
        sed -i "s|server: https://127.0.0.1:6443|server: https://brokkr-dev-k3s-1:6443|g" /tmp/brokkr-keys/kubeconfig.docker.yaml

        # Sleep to ensure files written
        sleep 10
      '

  # Local container registry for agent images and Shipwright builds
  registry:
    image: registry:2
    ports:
      - "5050:5000"
    volumes:
      - registry-data:/var/lib/registry
    healthcheck:
      test: ["CMD", "wget", "-q", "--spider", "http://localhost:5000/v2/"]
      interval: 5s
      timeout: 3s
      retries: 5

  # Build and push agent image to local registry
  build-agent-image:
    build:
      context: ../..
      dockerfile: docker/Dockerfile.agent
    image: localhost:5050/brokkr-agent:dev
    depends_on:
      registry:
        condition: service_healthy
    entrypoint: ["echo", "Image built"]

  push-agent-image:
    image: docker:27-cli
    depends_on:
      build-agent-image:
        condition: service_completed_successfully
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
    command: >
      sh -c '
        docker push localhost:5050/brokkr-agent:dev
      '

  # Deploy brokkr-agent via Helm chart into K3s
  # This triggers pre-install hooks for Tekton/Shipwright installation
  helm-install:
    image: alpine/k8s:1.30.2
    depends_on:
      init-kubeconfig:
        condition: service_completed_successfully
      init-agent:
        condition: service_completed_successfully
      push-agent-image:
        condition: service_completed_successfully
      brokkr-broker:
        condition: service_healthy
    volumes:
      - brokkr-keys:/tmp/brokkr-keys
      - ../../charts/brokkr-agent:/charts/brokkr-agent:ro
      - /var/run/docker.sock:/var/run/docker.sock
    entrypoint: []
    command: >
      sh -c '
        export KUBECONFIG=/tmp/brokkr-keys/kubeconfig.docker.yaml

        # Install docker CLI for inspecting broker IP
        apk add --no-cache docker-cli >/dev/null 2>&1

        # Wait for PAK file
        while [ ! -f /tmp/brokkr-keys/agent.pak ]; do
          echo "Waiting for agent PAK..."
          sleep 2
        done
        PAK=$$(cat /tmp/brokkr-keys/agent.pak)

        # Get the broker container IP address
        BROKER_IP=$$(docker inspect -f "{{range .NetworkSettings.Networks}}{{.IPAddress}}{{end}}" brokkr-dev-brokkr-broker-1 2>/dev/null || echo "")
        if [ -z "$$BROKER_IP" ]; then
          echo "Warning: Could not get broker IP, trying alternate container name..."
          BROKER_IP=$$(docker inspect -f "{{range .NetworkSettings.Networks}}{{.IPAddress}}{{end}}" brokkr-dev_brokkr-broker_1 2>/dev/null || echo "brokkr-broker")
        fi
        echo "Broker IP: $$BROKER_IP"

        # Get the registry container IP address
        REGISTRY_IP=$$(docker inspect -f "{{range .NetworkSettings.Networks}}{{.IPAddress}}{{end}}" brokkr-dev-registry-1 2>/dev/null || echo "")
        if [ -z "$$REGISTRY_IP" ]; then
          REGISTRY_IP=$$(docker inspect -f "{{range .NetworkSettings.Networks}}{{.IPAddress}}{{end}}" brokkr-dev_registry_1 2>/dev/null || echo "registry")
        fi
        echo "Registry IP: $$REGISTRY_IP"

        echo "Installing brokkr-agent via Helm..."
        helm upgrade --install brokkr-agent /charts/brokkr-agent \
          --namespace brokkr-system \
          --create-namespace \
          -f /charts/brokkr-agent/values-dev.yaml \
          --set broker.pak="$$PAK" \
          --set "hostAliases[0].ip=$$BROKER_IP" \
          --set "hostAliases[0].hostnames[0]=brokkr-broker" \
          --set "hostAliases[1].ip=$$REGISTRY_IP" \
          --set "hostAliases[1].hostnames[0]=registry" \
          --wait \
          --timeout 10m

        echo "Helm installation complete!"
        helm list -n brokkr-system
        kubectl get pods -n brokkr-system
        kubectl get pods -n tekton-pipelines
        kubectl get pods -n shipwright-build
        kubectl get clusterbuildstrategies
      '

  brokkr-ui:
    build:
      context: ../..
      dockerfile: docker/Dockerfile.ui-slim
    ports:
      - "3001:3001"
    depends_on:
      brokkr-broker:
        condition: service_healthy
    environment:
      - REACT_APP_BROKER_URL=http://localhost:3000
      - PORT=3001
      - REACT_APP_ADMIN_PAK=brokkr_BR3rVsDa_GK3QN7CDUzYc6iKgMkJ98M2WSimM5t6U8
    volumes:
      - brokkr-keys:/tmp/brokkr-keys

  copy-keys:
    image: alpine
    volumes:
      - brokkr-keys:/source:ro
      - /tmp/brokkr-keys:/destination
    command: >
      sh -c "
        mkdir -p /destination &&
        cp -r /source/* /destination/ &&
        chmod -R 777 /destination/
      "
    depends_on:
      init-agent:
        condition: service_completed_successfully
      init-kubeconfig:
        condition: service_completed_successfully

  copy-kubeconfig:
    image: alpine
    volumes:
      - brokkr-keys:/source:ro
      - /tmp/brokkr-keys:/destination
    command: >
      sh -c "
        mkdir -p /destination &&
        cp /source/kubeconfig.yaml /destination/ &&
        cp /source/kubeconfig.local.yaml /destination/ &&
        cp /source/kubeconfig.docker.yaml /destination/ &&
        chmod -R 777 /destination/
      "
    depends_on:
      init-kubeconfig:
        condition: service_completed_successfully

  # Readiness check - verifies entire stack is operational
  # Wait for this service to complete before running tests
  ready:
    image: alpine/k8s:1.30.2
    depends_on:
      helm-install:
        condition: service_completed_successfully
    volumes:
      - brokkr-keys:/tmp/brokkr-keys
    entrypoint: []
    command: >
      sh -c '
        export KUBECONFIG=/tmp/brokkr-keys/kubeconfig.docker.yaml

        echo "=== Checking infrastructure readiness ==="

        # Check Tekton
        echo "Checking Tekton..."
        kubectl wait --for=condition=available --timeout=120s deployment/tekton-pipelines-controller -n tekton-pipelines || exit 1
        kubectl wait --for=condition=available --timeout=120s deployment/tekton-pipelines-webhook -n tekton-pipelines || exit 1
        echo "✓ Tekton ready"

        # Check Shipwright
        echo "Checking Shipwright..."
        kubectl wait --for=condition=available --timeout=120s deployment/shipwright-build-controller -n shipwright-build || exit 1
        kubectl wait --for=condition=available --timeout=120s deployment/shipwright-build-webhook -n shipwright-build || exit 1
        echo "✓ Shipwright ready"

        # Check ClusterBuildStrategies exist
        echo "Checking ClusterBuildStrategies..."
        CBS_COUNT=$$(kubectl get clusterbuildstrategies --no-headers 2>/dev/null | wc -l)
        if [ "$$CBS_COUNT" -lt 1 ]; then
          echo "✗ No ClusterBuildStrategies found"
          exit 1
        fi
        echo "✓ ClusterBuildStrategies ready ($$CBS_COUNT strategies)"

        # Check Agent
        echo "Checking Agent..."
        kubectl wait --for=condition=available --timeout=120s deployment/brokkr-agent -n brokkr-system || exit 1
        echo "✓ Agent deployment ready"

        # Check agent can reach broker (look for successful heartbeat in logs)
        echo "Checking Agent-Broker connectivity..."
        for i in $$(seq 1 30); do
          if kubectl logs -n brokkr-system -l app.kubernetes.io/name=brokkr-agent --tail=50 2>/dev/null | grep -q "Successfully sent heartbeat"; then
            echo "✓ Agent connected to broker"
            break
          fi
          if [ $$i -eq 30 ]; then
            echo "✗ Agent not connected to broker after 30 attempts"
            kubectl logs -n brokkr-system -l app.kubernetes.io/name=brokkr-agent --tail=20
            exit 1
          fi
          sleep 2
        done

        echo ""
        echo "=========================================="
        echo "✓ Infrastructure ready!"
        echo "=========================================="
        echo ""
        echo "Tekton:      $$(kubectl get pods -n tekton-pipelines --no-headers | wc -l) pods"
        echo "Shipwright:  $$(kubectl get pods -n shipwright-build --no-headers | wc -l) pods"
        echo "Agent:       $$(kubectl get pods -n brokkr-system --no-headers | wc -l) pods"
        echo "Strategies:  $$CBS_COUNT ClusterBuildStrategies"
        echo ""
      '

volumes:
  brokkr-postgres-data:
  k3s-data:
  brokkr-keys:
  registry-data:
