---
name: brokkr-dev

services:
  postgres:
    image: postgres:15-alpine
    environment:
      - POSTGRES_USER=brokkr
      - POSTGRES_PASSWORD=brokkr
      - POSTGRES_DB=brokkr
    ports:
      - 5432:5432
    volumes:
      - brokkr-postgres-data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD", "pg_isready", "-U", "brokkr"]
      interval: 1s
      retries: 60
    restart: always

  brokkr-broker:
    command: serve
    build:
      context: ../..
      dockerfile: docker/Dockerfile.broker
    ports:
      - 3000:3000
    depends_on:
      postgres:
        condition: service_healthy
    environment:
      - BROKKR__DATABASE__URL=postgres://brokkr:brokkr@postgres:5432/brokkr
    volumes:
      - /tmp/brokkr-keys:/tmp/brokkr-keys
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:3000/readyz"]
      interval: 5s
      timeout: 3s
      retries: 10

  init-agent:
    build:
      context: ../..
      dockerfile: docker/Dockerfile.broker
    depends_on:
      brokkr-broker:
        condition: service_healthy
    environment:
      - BROKKR__DATABASE__URL=postgres://brokkr:brokkr@postgres:5432/brokkr
    volumes:
      - /tmp/brokkr-keys:/tmp/brokkr-keys
    entrypoint: []
    command: >
      sh -c "
        ./brokkr-broker create agent --name brokkr-integration-test-agent --cluster-name brokkr-dev-integration-cluster | tee /tmp/brokkr-keys/agent.out &&
        grep 'Initial PAK:' /tmp/brokkr-keys/agent.out | cut -d' ' -f3 > /tmp/brokkr-keys/agent.pak
      "

  brokkr-agent:
    build:
      context: ../..
      dockerfile: docker/Dockerfile.agent
    depends_on:
      init-agent:
        condition: service_completed_successfully
    environment:
      - BROKKR__AGENT__BROKER_URL=http://brokkr-broker:3000
      - BROKKR__AGENT__AGENT_NAME=brokkr-integration-test-agent
      - BROKKR__AGENT__CLUSTER_NAME=brokkr-dev-integration-cluster
    volumes:
      - /tmp/brokkr-keys:/tmp/brokkr-keys
    entrypoint: []
    command: sh -c "export BROKKR__AGENT__PAK=$(cat /tmp/brokkr-keys/agent.pak) && env && cat /tmp/brokkr-keys/agent.pak && ./brokkr-agent start"


  k3s:
    image: rancher/k3s:v1.27.3-k3s1
    command:
      - server
      - --cluster-init
      - --tls-san=k3s-server
      - --write-kubeconfig=/output/kubeconfig.yaml
      - --write-kubeconfig-mode=666
    privileged: true
    environment:
      - K3S_TOKEN=brokkr-secret
      - K3S_KUBECONFIG_OUTPUT=/output/kubeconfig.yaml
    volumes:
      - k3s-data:/var/lib/rancher/k3s
      - /tmp/brokkr-keys:/output
    ports:
      - "6443:6443"  # Kubernetes API server
    healthcheck:
      test: ["CMD", "kubectl", "get", "--raw", "/healthz"]
      interval: 10s
      timeout: 5s
      retries: 5

volumes:
  brokkr-postgres-data:
  k3s-data:
