---
name: brokkr-dev

services:
  postgres:
    image: postgres:15-alpine
    environment:
      - POSTGRES_USER=brokkr
      - POSTGRES_PASSWORD=brokkr
      - POSTGRES_DB=brokkr
    ports:
      - 5432:5432
    volumes:
      - brokkr-postgres-data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD", "pg_isready", "-U", "brokkr"]
      interval: 1s
      retries: 60
    restart: always

  brokkr-broker:
    command: serve
    build:
      context: ../..
      dockerfile: docker/Dockerfile.broker
    ports:
      - 3000:3000
    depends_on:
      - postgres
    environment:
      - BROKKR__DATABASE__URL=postgres://brokkr:brokkr@postgres:5432/brokkr
    volumes:
      - /tmp/brokkr-keys:/tmp/brokkr-keys

  brokkr-agent:
    build:
      context: ../..
      dockerfile: docker/Dockerfile.agent
    depends_on:
      - postgres
      - brokkr-broker
    environment:
      - BROKKR__BROKER_URL=http://brokkr-broker:3000

  k3s:
    image: rancher/k3s:v1.27.3-k3s1
    privileged: true
    environment:
      - K3S_TOKEN=brokkr-secret
      - K3S_KUBECONFIG_OUTPUT=/output/kubeconfig.yaml
    volumes:
      - k3s-data:/var/lib/rancher/k3s
      - /tmp/brokkr-keys:/output
    ports:
      - "6443:6443"  # Kubernetes API server
    command: server

volumes:
  brokkr-postgres-data:
  k3s-data: